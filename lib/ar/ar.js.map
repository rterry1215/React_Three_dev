{"version":3,"sources":["../../src/ar/ar.js"],"names":["ARContext","videoDomElemSelector","AR","React","memo","tracking","children","sourceType","patternRatio","matrixCodeType","detectionMode","cameraParametersUrl","onCameraStreamReady","onCameraStreamError","gl","camera","arContext","arToolkitSource","ArToolkitSource","arToolkitContext","ArToolkitContext","onResize","onResizeElement","copyElementSizeTo","domElement","arController","canvas","projectionMatrix","copy","getProjectionMatrix","onUnmount","window","removeEventListener","dispose","cameraParam","video","document","querySelector","srcObject","getTracks","map","track","stop","remove","init","style","position","onloadedmetadata","console","log","videoWidth","videoHeight","orientation","options","addEventListener","ready","update","value","useAR","arValue","useContext","useMemo"],"mappings":"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","sourcesContent":["import { useFrame, useThree } from \"@react-three/fiber\"\nimport { ArToolkitContext, ArToolkitSource } from \"@ar-js-org/ar.js/three.js/build/ar-threex\"\nimport React, { createContext, useCallback, useEffect, useMemo } from \"react\"\n\nconst ARContext = createContext({})\nconst videoDomElemSelector = \"#arjs-video\"\n\nconst AR = React.memo(\n  ({\n    tracking = true,\n    children,\n    sourceType,\n    patternRatio,\n    matrixCodeType,\n    detectionMode,\n    cameraParametersUrl,\n    onCameraStreamReady,\n    onCameraStreamError,\n  }) => {\n    const { gl, camera } = useThree()\n\n    const arContext = useMemo(() => {\n      const arToolkitSource = new ArToolkitSource({ sourceType })\n      const arToolkitContext = new ArToolkitContext({\n        cameraParametersUrl,\n        detectionMode,\n        patternRatio,\n        matrixCodeType,\n      })\n\n      return { arToolkitContext, arToolkitSource }\n    }, [patternRatio, matrixCodeType, cameraParametersUrl, detectionMode, sourceType])\n\n    const onResize = useCallback(() => {\n      const { arToolkitContext, arToolkitSource } = arContext\n\n      arToolkitSource.onResizeElement()\n      arToolkitSource.copyElementSizeTo(gl.domElement)\n      if (arToolkitContext.arController !== null) {\n        arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)\n        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix())\n      }\n    }, [gl, arContext, camera])\n\n    const onUnmount = useCallback(() => {\n      window.removeEventListener(\"resize\", onResize)\n\n      arContext.arToolkitContext.arController.dispose()\n      if (arContext.arToolkitContext.arController.cameraParam) {\n        arContext.arToolkitContext.arController.cameraParam.dispose()\n      }\n\n      delete arContext.arToolkitContext\n      delete arContext.arToolkitSource\n\n      const video = document.querySelector(videoDomElemSelector)\n      if (video) {\n        video.srcObject.getTracks().map(track => track.stop())\n        video.remove()\n      }\n    }, [onResize, arContext])\n\n    useEffect(() => {\n      arContext.arToolkitSource.init(() => {\n        const video = document.querySelector(videoDomElemSelector)\n        video.style.position = \"fixed\"\n\n        video.onloadedmetadata = () => {\n          console.log(\"actual source dimensions\", video.videoWidth, video.videoHeight)\n\n          if (video.videoWidth > video.videoHeight) {\n            arContext.arToolkitContext.arController.orientation = \"landscape\"\n            arContext.arToolkitContext.arController.options.orientation = \"landscape\"\n          } else {\n            arContext.arToolkitContext.arController.orientation = \"portrait\"\n            arContext.arToolkitContext.arController.options.orientation = \"portrait\"\n          }\n\n          if (onCameraStreamReady) {\n            onCameraStreamReady()\n          }\n          onResize()\n        }\n      }, onCameraStreamError)\n\n      arContext.arToolkitContext.init(() =>\n        camera.projectionMatrix.copy(arContext.arToolkitContext.getProjectionMatrix()),\n      )\n\n      window.addEventListener(\"resize\", onResize)\n\n      return onUnmount\n    }, [arContext, camera, onCameraStreamReady, onCameraStreamError, onResize, onUnmount])\n\n    useFrame(() => {\n      if (!tracking) {\n        return\n      }\n\n      if (arContext.arToolkitSource && arContext.arToolkitSource.ready !== false) {\n        arContext.arToolkitContext.update(arContext.arToolkitSource.domElement)\n      }\n    })\n\n    const value = useMemo(() => ({ arToolkitContext: arContext.arToolkitContext }), [arContext])\n\n    return <ARContext.Provider value={value}>{children}</ARContext.Provider>\n  },\n)\n\nconst useAR = () => {\n  const arValue = React.useContext(ARContext)\n  return React.useMemo(() => ({ ...arValue }), [arValue])\n}\n\nexport { AR, useAR }\n"],"file":"ar.js"}