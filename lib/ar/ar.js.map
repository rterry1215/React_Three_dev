{"version":3,"sources":["../../src/ar/ar.js"],"names":["React","createContext","useCallback","useEffect","useMemo","useFrame","useThree","ARContext","videoDomElemSelector","AR","children","patternRatio","matrixCodeType","detectionMode","cameraParametersUrl","onCameraStreamReady","onCameraStreamError","gl","camera","arContext","arToolkitSource","THREEx","ArToolkitSource","sourceType","arToolkitContext","ArToolkitContext","onResize","onResizeElement","copyElementSizeTo","domElement","arController","canvas","projectionMatrix","copy","getProjectionMatrix","onUnmount","window","removeEventListener","dispose","cameraParam","video","document","querySelector","srcObject","getTracks","map","track","stop","remove","init","onloadedmetadata","addEventListener","ready","update","value","useAR","arValue","useContext"],"mappings":"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","sourcesContent":["import React, { createContext, useCallback, useEffect, useMemo } from \"react\"\nimport { useFrame, useThree } from \"@react-three/fiber\"\n\nconst ARContext = createContext({})\nconst videoDomElemSelector = \"#arjs-video\"\n\nconst AR = ({\n  children,\n  patternRatio,\n  matrixCodeType,\n  detectionMode,\n  cameraParametersUrl,\n  onCameraStreamReady,\n  onCameraStreamError\n}) => {\n  const { gl, camera } = useThree()\n\n  const arContext = useMemo(() => {\n    const arToolkitSource = new THREEx.ArToolkitSource({ sourceType: \"webcam\" })\n    const arToolkitContext = new THREEx.ArToolkitContext({\n      cameraParametersUrl,\n      detectionMode,\n      patternRatio,\n      matrixCodeType\n    })\n\n    return { arToolkitContext, arToolkitSource }\n  }, [patternRatio, matrixCodeType, cameraParametersUrl, detectionMode])\n\n  const onResize = useCallback(() => {\n    const { arToolkitContext, arToolkitSource } = arContext\n\n    arToolkitSource.onResizeElement()\n    arToolkitSource.copyElementSizeTo(gl.domElement)\n    if (arToolkitContext.arController !== null) {\n      arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)\n      camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix())\n    }\n  }, [gl, arContext, camera])\n\n  const onUnmount = useCallback(() => {\n    window.removeEventListener(\"resize\", onResize)\n\n    arContext.arToolkitContext.arController.dispose()\n    if (arContext.arToolkitContext.arController.cameraParam) {\n      arContext.arToolkitContext.arController.cameraParam.dispose()\n    }\n\n    delete arContext.arToolkitContext\n    delete arContext.arToolkitSource\n\n    const video = document.querySelector(videoDomElemSelector)\n    video.srcObject.getTracks().map(track => track.stop())\n    video.remove()\n  }, [onResize, arContext])\n\n  useEffect(() => {\n    arContext.arToolkitSource.init(() => {\n      const video = document.querySelector(videoDomElemSelector)\n      video.onloadedmetadata = () => {\n        onCameraStreamReady()\n        onResize()\n      }\n    }, onCameraStreamError)\n\n    arContext.arToolkitContext.init(() =>\n      camera.projectionMatrix.copy(arContext.arToolkitContext.getProjectionMatrix())\n    )\n\n    window.addEventListener(\"resize\", onResize)\n\n    return onUnmount\n  }, [arContext, camera, onCameraStreamReady, onCameraStreamError, onResize, onUnmount])\n\n  useFrame(() => {\n    if (arContext.arToolkitSource && arContext.arToolkitSource.ready !== false) {\n      arContext.arToolkitContext.update(arContext.arToolkitSource.domElement)\n    }\n  })\n\n  const value = useMemo(() => ({ arToolkitContext: arContext.arToolkitContext }), [arContext])\n\n  return (\n    <ARContext.Provider value={ value }>\n      { children }\n    </ARContext.Provider>\n  )\n}\n\nconst useAR = () => {\n  const arValue = React.useContext(ARContext)\n  return React.useMemo(() => ({ ...arValue }), [arValue])\n}\n\nexport { AR, useAR }\n"],"file":"ar.js"}